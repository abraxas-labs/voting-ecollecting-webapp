<div class="layout page">
  @if (collection && sheet) {
    <div class="layout-header">
      <bc-sub-navigation-bar [type]="'subpage'" [border]="false" (actionClick)="backWithUnsavedChangesCheck()">
        <h4 sub-navigation-title truncateWithTooltip tooltip>{{ 'COLLECTION.CHECK_SAMPLES.SIGNATURE_SHEETS.DETAIL.TITLE' | translate }}</h4>
        @if (sheet.userPermissions?.canConfirm) {
          <bc-button
            (buttonClick)="resetChanges()"
            [variant]="'tertiary'"
            [label]="'COLLECTION.CHECK_SAMPLES.SIGNATURE_SHEETS.DETAIL.RESET_CHANGES.TITLE' | translate"
            [disabled]="!hasChanges"
            icon="undo"
          ></bc-button>
          <bc-button
            (buttonClick)="save()"
            [variant]="'tertiary'"
            [label]="'COLLECTION.CHECK_SAMPLES.SIGNATURE_SHEETS.DETAIL.SAVE.TITLE' | translate"
            [icon]="'checkmark'"
          ></bc-button>
        }
      </bc-sub-navigation-bar>
      <bc-divider [orientation]="'horizontal'"></bc-divider>
      <app-signature-sheet-header>
        <ng-container header-info>
          <bc-readonly [label]="'COLLECTION.CHECK_SAMPLES.SIGNATURE_SHEETS.DETAIL.MUNICIPALITY_NAME' | translate">
            {{ sheet.municipalityName }}
          </bc-readonly>
        </ng-container>
      </app-signature-sheet-header>
    </div>

    <div class="layout-content overflow-auto p-4">
      @if (sheet.userPermissions?.canConfirm) {
        <p>{{ 'COLLECTION.CHECK_SAMPLES.SIGNATURE_SHEETS.DETAIL.INFO' | translate }}</p>
      } @else {
        <p class="immutable-hint">{{ 'COLLECTION.CHECK_SAMPLES.SIGNATURE_SHEETS.DETAIL.IMMUTABLE_HINT' | translate }}</p>
      }

      <div class="info p-3 gap-x-4">
        <div>
          <div class="stats gap-x-3 gap-y-1">
            <span>{{ 'COLLECTION.CHECK_SAMPLES.SIGNATURE_SHEETS.DETAIL.COUNT.TOTAL' | translate }}</span>
            <span class="value">{{ sheet.count.total | number }}</span>
            @if (sheet.userPermissions?.canConfirm) {
              <bc-icon-button class="mb-3" [icon]="'plus'" [variant]="'tertiary'" (buttonClick)="updateTotal(1)"></bc-icon-button>
              <bc-icon-button
                class="mb-3"
                [icon]="'minus'"
                [variant]="'tertiary'"
                (buttonClick)="updateTotal(-1)"
                [disabled]="sheet.count.invalid === 0"
              ></bc-icon-button>
            }
            <span>{{ 'COLLECTION.CHECK_SAMPLES.SIGNATURE_SHEETS.DETAIL.COUNT.INVALID' | translate }}</span>
            <span class="value">{{ sheet.count.invalid | number }}</span>
            <span>{{ 'COLLECTION.CHECK_SAMPLES.SIGNATURE_SHEETS.DETAIL.COUNT.VALID' | translate }}</span>
            <span class="value">{{ sheet.count.valid | number }}</span>
          </div>
        </div>
        <app-signature-sheet-citizen-table
          class="p-2"
          [canReview]="sheet.userPermissions?.canConfirm ?? false"
          [loading]="loadingCitizens"
          [citizens]="citizens"
          (remove)="removeCitizen($event)"
          (confirm)="confirmCitizen($event)"
          (revert)="revertCitizen($event)"
        ></app-signature-sheet-citizen-table>
      </div>

      @if (sheet.userPermissions?.canConfirm) {
        <p class="mt-4">
          {{
            'COLLECTION.CHECK_SAMPLES.SIGNATURE_SHEETS.DETAIL.SEARCH_HINT'
              | translate: { receivedAt: sheet.receivedAt | date: 'dd.MM.yyyy' }
          }}
        </p>
        <app-signature-sheet-person-search (filter)="search($event)"></app-signature-sheet-person-search>
        <p class="mt-3 mb-2">
          {{
            'COLLECTION.CHECK_SAMPLES.SIGNATURE_SHEETS.DETAIL.FOUND' | translate: { count: personCandidatesPage.totalItemsCount | number }
          }}
        </p>
        <vo-ecol-loading-bar [loading]="searching"></vo-ecol-loading-bar>
        <app-signature-sheet-candidates-table
          class="mb-3 block"
          [canAdd]="sheet.count.invalid > 0"
          [candidates]="personCandidatesPage"
          (pageChange)="search(undefined, $event)"
          (add)="add($event)"
        ></app-signature-sheet-candidates-table>
      }
    </div>
  }
</div>
